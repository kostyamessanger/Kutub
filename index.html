<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Kutub</title>

<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #0f0f0f;
    color: white;
  }

  header {
    padding: 15px;
    background: #181818;
    font-size: 22px;
    font-weight: bold;
  }

  #status {
    padding: 10px;
    font-size: 14px;
    color: #aaa;
  }

  #videos {
    padding: 10px;
  }

  .video {
    background: #1f1f1f;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 10px;
  }

  .video h3 {
    margin: 0 0 5px 0;
  }

  .like-btn {
    background: #ff0033;
    border: none;
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
  }

  /* –ó–∞–≥—Ä—É–∑–∫–∞ */
  #loader {
    display: flex;
    justify-content: center;
    margin-top: 40px;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #333;
    border-top: 4px solid #ff0033;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0); }
    100% { transform: rotate(360deg); }
  }

  /* –ü–ª–∞—à–∫–∞ —Å–Ω–∏–∑—É */
  #toast {
    position: fixed;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
    background: #222;
    padding: 10px 20px;
    border-radius: 6px;
    display: none;
  }
</style>
</head>

<body>

<header>üé¨ Kutub</header>
<div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

<div id="loader"><div class="spinner"></div></div>
<div id="videos"></div>

<div id="toast"></div>

<script>
const API = "https://kutub-server.k90183621.workers.dev";
const statusEl = document.getElementById("status");
const videosEl = document.getElementById("videos");
const loader = document.getElementById("loader");

function showToast(text) {
  const toast = document.getElementById("toast");
  toast.innerText = text;
  toast.style.display = "block";
  setTimeout(() => toast.style.display = "none", 4000);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
if (!navigator.onLine) {
  statusEl.innerText = "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É ‚ùå";
  showToast("–ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç");
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ
async function loadVideos() {
  try {
    loader.style.display = "flex";
    videosEl.innerHTML = "";

    const res = await fetch(API + "/videos", { cache: "no-store" });
    if (!res.ok) throw new Error();

    const data = await res.json();
    statusEl.innerText = "–°–µ—Ä–≤–µ—Ä –æ–Ω–ª–∞–π–Ω ‚úÖ";
    loader.style.display = "none";

    data.videos.forEach(v => {
      const div = document.createElement("div");
      div.className = "video";
      div.innerHTML = 
        <h3>${v.title}</h3>
        <p>‚ù§Ô∏è <span id="likes-${v.id}">${v.likes}</span></p>
        <button class="like-btn" onclick="like(${v.id})">–õ–∞–π–∫</button>
      ;
      videosEl.appendChild(div);
    });

  } catch {
    statusEl.innerText = "–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚ùå";
    showToast("–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫");
    setTimeout(loadVideos, 3000); // –±–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞
  }
}

// –õ–∞–π–∫
function like(id) {
  fetch(API + "/like", {
    method: "POST",
    headers: { "content-type": "application/json" },
    body: JSON.stringify({ videoId: id })
  });

  const el = document.getElementById("likes-" + id);
  el.innerText = Number(el.innerText) + 1;
}

loadVideos();

// –û–Ω–ª–∞–π–Ω / –æ—Ñ—Ñ–ª–∞–π–Ω
window.addEventListener("offline", () => {
  showToast("–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É");
});

window.addEventListener("online", () => {
  showToast("–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω");
  loadVideos();
});
</script>

</body>
</html>
